# MedSpa AI - iOS CI/CD Pipeline
# Builds, tests, and deploys to TestFlight via GitHub Actions

name: iOS CI/CD

on:
  push:
    branches: [main, develop]
    paths:
      - 'MedSpaAI/**'
      - '.github/workflows/ios.yml'
  pull_request:
    branches: [main]
    paths:
      - 'MedSpaAI/**'
  workflow_dispatch:
    inputs:
      deploy_testflight:
        description: 'Deploy to TestFlight'
        required: true
        default: 'false'
        type: boolean

env:
  XCODE_VERSION: '15.2'
  IOS_DESTINATION: 'platform=iOS Simulator,name=iPhone 15 Pro,OS=17.2'
  SCHEME: 'MedSpaAI'
  PROJECT_PATH: 'MedSpaAI'

jobs:
  # ============================================
  # BUILD & TEST
  # ============================================
  build-and-test:
    name: Build & Test
    runs-on: macos-14
    
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
      
      - name: Select Xcode Version
        run: sudo xcode-select -s /Applications/Xcode_${{ env.XCODE_VERSION }}.app
      
      - name: Show Xcode Version
        run: xcodebuild -version
      
      - name: Cache SPM Dependencies
        uses: actions/cache@v4
        with:
          path: |
            ~/Library/Caches/org.swift.swiftpm
            ~/Library/Developer/Xcode/DerivedData
          key: ${{ runner.os }}-spm-${{ hashFiles('**/Package.resolved') }}
          restore-keys: |
            ${{ runner.os }}-spm-
      
      - name: Resolve Dependencies
        working-directory: ${{ env.PROJECT_PATH }}
        run: |
          xcodebuild -resolvePackageDependencies \
            -scheme "${{ env.SCHEME }}" \
            -clonedSourcePackagesDirPath ../SourcePackages
      
      - name: Build for Testing
        working-directory: ${{ env.PROJECT_PATH }}
        run: |
          set -o pipefail
          xcodebuild build-for-testing \
            -scheme "${{ env.SCHEME }}" \
            -destination "${{ env.IOS_DESTINATION }}" \
            -clonedSourcePackagesDirPath ../SourcePackages \
            -enableCodeCoverage YES \
            | xcpretty --color
      
      - name: Run Unit Tests
        working-directory: ${{ env.PROJECT_PATH }}
        run: |
          set -o pipefail
          xcodebuild test-without-building \
            -scheme "${{ env.SCHEME }}" \
            -destination "${{ env.IOS_DESTINATION }}" \
            -clonedSourcePackagesDirPath ../SourcePackages \
            -enableCodeCoverage YES \
            -resultBundlePath TestResults.xcresult \
            | xcpretty --color --report junit
      
      - name: Upload Test Results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: test-results
          path: |
            ${{ env.PROJECT_PATH }}/TestResults.xcresult
            build/reports/junit.xml
          retention-days: 14
      
      - name: Generate Coverage Report
        working-directory: ${{ env.PROJECT_PATH }}
        run: |
          xcrun xccov view --report --json TestResults.xcresult > coverage.json
          echo "## Code Coverage Summary" >> $GITHUB_STEP_SUMMARY
          cat coverage.json | jq -r '.targets[] | select(.name | contains("MedSpaAI")) | "**\(.name)**: \(.lineCoverage * 100 | round)%"' >> $GITHUB_STEP_SUMMARY
      
      - name: Check Coverage Threshold
        working-directory: ${{ env.PROJECT_PATH }}
        run: |
          COVERAGE=$(cat coverage.json | jq -r '.targets[] | select(.name == "MedSpaAI.app") | .lineCoverage')
          THRESHOLD=0.60
          if (( $(echo "$COVERAGE < $THRESHOLD" | bc -l) )); then
            echo "::warning::Code coverage ($COVERAGE) is below threshold ($THRESHOLD)"
          fi

  # ============================================
  # BUILD FOR RELEASE
  # ============================================
  build-release:
    name: Build Release
    runs-on: macos-14
    needs: build-and-test
    if: github.ref == 'refs/heads/main' || github.event.inputs.deploy_testflight == 'true'
    
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
      
      - name: Select Xcode Version
        run: sudo xcode-select -s /Applications/Xcode_${{ env.XCODE_VERSION }}.app
      
      - name: Import Signing Certificate
        uses: apple-actions/import-codesign-certs@v2
        with:
          p12-file-base64: ${{ secrets.CERTIFICATES_P12 }}
          p12-password: ${{ secrets.CERTIFICATES_P12_PASSWORD }}
      
      - name: Download Provisioning Profile
        uses: apple-actions/download-provisioning-profiles@v2
        with:
          bundle-id: 'com.medspaai.app'
          issuer-id: ${{ secrets.APPSTORE_ISSUER_ID }}
          api-key-id: ${{ secrets.APPSTORE_KEY_ID }}
          api-private-key: ${{ secrets.APPSTORE_PRIVATE_KEY }}
      
      - name: Increment Build Number
        working-directory: ${{ env.PROJECT_PATH }}
        run: |
          BUILD_NUMBER=$(($(date +%Y%m%d%H%M)))
          agvtool new-version -all $BUILD_NUMBER
          echo "Build number: $BUILD_NUMBER"
      
      - name: Build Archive
        working-directory: ${{ env.PROJECT_PATH }}
        run: |
          set -o pipefail
          xcodebuild archive \
            -scheme "${{ env.SCHEME }}" \
            -archivePath build/MedSpaAI.xcarchive \
            -destination "generic/platform=iOS" \
            -clonedSourcePackagesDirPath ../SourcePackages \
            CODE_SIGN_STYLE=Manual \
            DEVELOPMENT_TEAM="${{ secrets.DEVELOPMENT_TEAM_ID }}" \
            | xcpretty --color
      
      - name: Export IPA
        working-directory: ${{ env.PROJECT_PATH }}
        run: |
          xcodebuild -exportArchive \
            -archivePath build/MedSpaAI.xcarchive \
            -exportPath build/Export \
            -exportOptionsPlist ExportOptions.plist
      
      - name: Upload Build Artifact
        uses: actions/upload-artifact@v4
        with:
          name: MedSpaAI-Release
          path: ${{ env.PROJECT_PATH }}/build/Export/*.ipa
          retention-days: 30

  # ============================================
  # DEPLOY TO TESTFLIGHT
  # ============================================
  deploy-testflight:
    name: Deploy to TestFlight
    runs-on: macos-14
    needs: build-release
    if: github.ref == 'refs/heads/main' || github.event.inputs.deploy_testflight == 'true'
    environment: production
    
    steps:
      - name: Download Build Artifact
        uses: actions/download-artifact@v4
        with:
          name: MedSpaAI-Release
          path: build
      
      - name: Upload to TestFlight
        uses: apple-actions/upload-testflight-build@v1
        with:
          app-path: build/MedSpaAI.ipa
          issuer-id: ${{ secrets.APPSTORE_ISSUER_ID }}
          api-key-id: ${{ secrets.APPSTORE_KEY_ID }}
          api-private-key: ${{ secrets.APPSTORE_PRIVATE_KEY }}
      
      - name: Post to Slack
        if: success()
        uses: slackapi/slack-github-action@v1
        with:
          payload: |
            {
              "text": "ðŸš€ MedSpa AI deployed to TestFlight!",
              "blocks": [
                {
                  "type": "section",
                  "text": {
                    "type": "mrkdwn",
                    "text": "*MedSpa AI* has been deployed to TestFlight\nâ€¢ Branch: `${{ github.ref_name }}`\nâ€¢ Commit: `${{ github.sha }}`"
                  }
                }
              ]
            }
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
      
      - name: Create GitHub Release
        if: success()
        uses: softprops/action-gh-release@v1
        with:
          tag_name: v${{ github.run_number }}
          name: Build ${{ github.run_number }}
          draft: false
          prerelease: true
          files: build/MedSpaAI.ipa
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  # ============================================
  # NOTIFY ON FAILURE
  # ============================================
  notify-failure:
    name: Notify on Failure
    runs-on: ubuntu-latest
    needs: [build-and-test, build-release, deploy-testflight]
    if: failure()
    
    steps:
      - name: Post Failure to Slack
        uses: slackapi/slack-github-action@v1
        with:
          payload: |
            {
              "text": "âŒ MedSpa AI CI/CD Failed",
              "blocks": [
                {
                  "type": "section",
                  "text": {
                    "type": "mrkdwn",
                    "text": "*MedSpa AI CI/CD Pipeline Failed*\nâ€¢ Branch: `${{ github.ref_name }}`\nâ€¢ <${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}|View Run>"
                  }
                }
              ]
            }
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
